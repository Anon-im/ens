{"version":3,"file":"zkevm-resolver-gateway.esm.js","sources":["../src/index.ts"],"sourcesContent":["import { Server } from \"@chainlink/ccip-read-server\";\nimport { Command } from \"commander\";\nimport { ethers } from \"ethers\";\n\nconst IResolverAbi =\n  require(\"@ensdomains/arb-resolver-contracts/artifacts/contracts/l1/ArbitrumResolverStub.sol/IResolverService.json\").abi;\nconst helperAbi =\n  require(\"@ensdomains/arb-resolver-contracts/artifacts/contracts/l1/AssertionHelper.sol/AssertionHelper.json\").abi;\n\nconst rollupAbi = require(\"./rollup.json\");\nconst { BigNumber } = ethers;\nconst program = new Command();\nprogram\n  .option(\"-r --l2_resolver_address <address>\", \"RESOLVER_ADDRESS\")\n  .option(\"-h --helper_address <helper_address>\", \"HELPER_ADDRESS\")\n  .option(\n    \"-l1p --l1_provider_url <url1>\",\n    \"L1_PROVIDER_URL\",\n    \"http://localhost:8545\"\n  )\n  .option(\n    \"-l2p --l2_provider_url <url2>\",\n    \"L2_PROVIDER_URL\",\n    \"http://localhost:8545\"\n  )\n  .option(\"-l1c --l1_chain_id <chain1>\", \"L1_CHAIN_ID\", \"1337\")\n  .option(\"-l2c --l2_chain_id <chain2>\", \"L2_CHAIN_ID\", \"412346\")\n  .option(\n    \"-ru --rollup_address <rollup_address>\",\n    \"ROLLUP_ADDRESS\",\n    \"0xE87d317eB8dcc9afE24d9f63D6C760e52Bc18A40\"\n  )\n  .option(\"-d --debug\", \"debug\", false)\n  .option(\"-p --port <number>\", \"Port number to serve on\", \"8081\");\nprogram.parse(process.argv);\nconst options = program.opts();\nconsole.log({ options });\nconst {\n  l1_provider_url,\n  l2_provider_url,\n  rollup_address,\n  helper_address,\n  l2_resolver_address,\n  l1_chain_id,\n  l2_chain_id,\n  debug,\n} = options;\nif (helper_address === undefined || l2_resolver_address === undefined) {\n  throw \"Must specify --l2_resolver_address and --helper_address\";\n}\n\nconst l1provider = new ethers.providers.JsonRpcProvider(l1_provider_url);\nconst l2provider = new ethers.providers.JsonRpcProvider(l2_provider_url);\nconst rollup = new ethers.Contract(rollup_address, rollupAbi, l1provider);\nconst helper = new ethers.Contract(helper_address, helperAbi, l1provider);\nconst server = new Server();\n\nserver.add(IResolverAbi, [\n  {\n    type: \"addr(bytes32)\",\n    func: async ([node], { to, data: _callData }) => {\n      const addrSlot = ethers.utils.keccak256(node + \"00\".repeat(31) + \"01\");\n      if (debug) {\n        console.log(1, {\n          node,\n          to,\n          _callData,\n          l1_provider_url,\n          l2_provider_url,\n          l2_resolver_address,\n          l1_chain_id,\n          l2_chain_id,\n        });\n        const blockNumber = (await l2provider.getBlock(\"latest\")).number;\n        console.log(2, { blockNumber, addrSlot });\n        let addressData;\n        try {\n          addressData = await l2provider.getStorageAt(\n            l2_resolver_address,\n            addrSlot\n          );\n        } catch (e) {\n          console.log(3, { e });\n        }\n        console.log(4, {\n          addressData,\n        });\n      }\n      const nodeIndex = await rollup.lastFinalizedStateRootHash();\n      console.log({\n        nodeIndex: nodeIndex.toString(),\n      });\n      const nodeEventFilter = await rollup.filters.NodeCreated(nodeIndex);\n      const nodeEvents = await rollup.queryFilter(nodeEventFilter);\n      const assertion = nodeEvents[0].args!.assertion;\n      const sendRoot = await helper.getSendRoot(assertion);\n      const blockHash = await helper.getBlockHash(assertion);\n      const l2blockRaw = await l2provider.send(\"eth_getBlockByHash\", [\n        blockHash,\n        false,\n      ]);\n      console.log(5, { l2blockRaw });\n      const stateRoot = l2blockRaw.stateRoot;\n      const blockarray = [\n        l2blockRaw.parentHash,\n        l2blockRaw.sha3Uncles,\n        l2blockRaw.miner,\n        l2blockRaw.stateRoot,\n        l2blockRaw.transactionsRoot,\n        l2blockRaw.receiptsRoot,\n        l2blockRaw.logsBloom,\n        BigNumber.from(l2blockRaw.difficulty).toHexString(),\n        BigNumber.from(l2blockRaw.number).toHexString(),\n        BigNumber.from(l2blockRaw.gasLimit).toHexString(),\n        BigNumber.from(l2blockRaw.gasUsed).toHexString(),\n        BigNumber.from(l2blockRaw.timestamp).toHexString(),\n        l2blockRaw.extraData,\n        l2blockRaw.mixHash,\n        l2blockRaw.nonce,\n        BigNumber.from(l2blockRaw.baseFeePerGas).toHexString(),\n      ];\n      const encodedBlockArray = ethers.utils.RLP.encode(blockarray);\n      const slot = ethers.utils.keccak256(node + \"00\".repeat(31) + \"01\");\n      const proof = await l2provider.send(\"eth_getProof\", [\n        l2_resolver_address,\n        [slot],\n        { blockHash },\n      ]);\n      console.log(6, JSON.stringify(proof, null, 2));\n      const accountProof = ethers.utils.RLP.encode(proof.accountProof);\n      const storageProof = ethers.utils.RLP.encode(\n        (proof.storageProof as any[]).filter((x) => x.key === slot)[0].proof\n      );\n      const finalProof = {\n        nodeIndex,\n        blockHash,\n        sendRoot,\n        encodedBlockArray,\n        stateTrieWitness: accountProof,\n        stateRoot,\n        storageTrieWitness: storageProof,\n      };\n      console.log(7, { finalProof });\n      return [finalProof];\n    },\n  },\n]);\nconst app = server.makeApp(\"/\");\napp.listen(options.port);\n"],"names":["IResolverAbi","require","abi","helperAbi","rollupAbi","BigNumber","ethers","program","Command","option","parse","process","argv","options","opts","console","log","l1_provider_url","l2_provider_url","rollup_address","helper_address","l2_resolver_address","l1_chain_id","l2_chain_id","debug","undefined","l1provider","providers","JsonRpcProvider","l2provider","rollup","Contract","helper","server","Server","add","type","func","_func","_asyncToGenerator","_regeneratorRuntime","mark","_callee","_ref","_ref2","node","to","_callData","addrSlot","blockNumber","addressData","nodeIndex","nodeEventFilter","nodeEvents","assertion","sendRoot","blockHash","l2blockRaw","stateRoot","blockarray","encodedBlockArray","slot","proof","accountProof","storageProof","finalProof","wrap","_callee$","_context","prev","next","data","utils","keccak256","repeat","getBlock","sent","number","getStorageAt","t0","e","lastFinalizedStateRootHash","toString","filters","NodeCreated","queryFilter","args","getSendRoot","getBlockHash","send","parentHash","sha3Uncles","miner","transactionsRoot","receiptsRoot","logsBloom","from","difficulty","toHexString","gasLimit","gasUsed","timestamp","extraData","mixHash","nonce","baseFeePerGas","RLP","encode","JSON","stringify","filter","x","key","stateTrieWitness","storageTrieWitness","abrupt","stop","_x","_x2","apply","arguments","app","makeApp","listen","port"],"mappings":"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"}